{% extends 'ecom/admin_base.html' %}
{% load static %}
{% block content %}

<div class="container-fluid px-4">
  <div class="card shadow-sm border-0 mb-4">
    <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
      <h5 class="mb-0 font-weight-bold text-primary">
        <i class="fas fa-shopping-cart me-2"></i>Order Management
      </h5>
      <div class="d-flex gap-2">
        <input type="text" class="form-control form-control-sm" id="orderSearch" placeholder="Search orders...">
        <select class="form-control form-control-sm" id="statusFilter">
          <option value="">All Status</option>
          <option value="pending">Pending</option>
          <option value="delivered">Delivered</option>
          <option value="cancelled">Cancelled</option>
        </select>
      </div>
    </div>
    
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0" id="ordersTable">
          <thead class="bg-light">
            <tr>
              <th class="px-4 py-3">Customer</th>
              <th class="py-3">Contact</th>
              <th class="py-3">Shipping Address</th>
              <th class="py-3">Product</th>
              <th class="py-3">Quantity</th>
              <th class="py-3">Image</th>
              <th class="py-3">Status</th>
              <th class="py-3 text-end pe-4">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for product, customer, order in data %}
            <tr>
              {% for c in customer %}
              <td class="px-4">
                <div class="d-flex align-items-center">
                  <div class="avatar avatar-sm me-2">
                    <div class="avatar-initial rounded-circle bg-primary">
                      {{ c.get_name|slice:":1" }}
                    </div>
                  </div>
                  <div>
                    <h6 class="mb-0">{{ c.get_name }}</h6>
                    <small class="text-muted">ID: #{{ order.id }}</small>
                  </div>
                </div>
              </td>
              <td>
                <div class="d-flex align-items-center">
                  <i class="fas fa-phone-alt text-muted me-2"></i>
                  {{ c.mobile }}
                </div>
              </td>
              <td>
                <div class="d-flex align-items-center">
                  <i class="fas fa-map-marker-alt text-muted me-2"></i>
                  <span class="text-truncate" style="max-width: 200px;" title="{{ order.address }}">
                    {{ order.address }}
                  </span>
                </div>
              </td>
              {% endfor %}
              {% for p in product %}
              <td>{{ p.name }}</td>
              <td>
                <span class="badge bg-light text-dark">
                  {{ p.quantity }} {{p.unit}}
                </span>
              </td>
              <td>
                <img src="{% static p.product_image.url %}" 
                     class="rounded-3 border" 
                     alt="{{ p.name }}" 
                     height="40" 
                     width="40" />
              </td>
              <td>
                <span class="badge {% if order.status == 'Delivered' %}bg-success{% elif order.status == 'Pending' %}bg-warning{% else %}bg-danger{% endif %}">
                  {{ order.status }}
                </span>
              </td>
              <td class="text-end pe-4">
                <div class="btn-group btn-group-sm">
                  <a href="{% url 'update-order' order.id %}" 
                     class="btn btn-outline-primary" 
                     data-bs-toggle="tooltip" 
                     title="Edit Order">
                    <i class="fas fa-edit"></i>
                  </a>
                  <a href="{% url 'delete-order' order.id %}" 
                     class="btn btn-outline-danger" 
                     data-bs-toggle="tooltip" 
                     title="Delete Order"
                     onclick="return confirm('Are you sure you want to delete this order?')">
                    <i class="fas fa-trash-alt"></i>
                  </a>
                </div>
              </td>
              {% endfor %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<style>
.card {
  border-radius: 0.75rem;
}

.card-header {
  border-bottom: 1px solid rgba(0,0,0,.05);
}

.avatar {
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.avatar-initial {
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: 500;
}

.table > :not(caption) > * > * {
  padding: 1rem 0;
}

.table img {
  object-fit: cover;
}

.badge {
  padding: 0.5em 0.75em;
  font-weight: 500;
}

.btn-group .btn {
  padding: 0.25rem 0.5rem;
}

.btn-group .btn i {
  font-size: 0.875rem;
}

.text-truncate {
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

#orderSearch, #statusFilter {
  max-width: 200px;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Initialize tooltips
  var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
  var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl)
  });

  // Search functionality
  document.getElementById('orderSearch').addEventListener('keyup', function() {
    var input = this.value.toLowerCase();
    var table = document.getElementById('ordersTable');
    var rows = table.getElementsByTagName('tr');

    for (var i = 1; i < rows.length; i++) {
      var text = rows[i].textContent.toLowerCase();
      rows[i].style.display = text.indexOf(input) > -1 ? '' : 'none';
    }
  });

  // Status filter
  document.getElementById('statusFilter').addEventListener('change', function() {
    var value = this.value.toLowerCase();
    var table = document.getElementById('ordersTable');
    var rows = table.getElementsByTagName('tr');

    for (var i = 1; i < rows.length; i++) {
      var statusCell = rows[i].getElementsByTagName('td')[6];
      if (statusCell) {
        var status = statusCell.textContent.toLowerCase();
        rows[i].style.display = !value || status.indexOf(value) > -1 ? '' : 'none';
      }
    }
  });
});
</script>
{% endblock content %}